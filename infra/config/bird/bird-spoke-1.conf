# BIRD configuration for spoke-1-router
# Spoke-1 VPC: 172.17.0.0/16
# WireGuard tunnel: 10.0.1.2/30 to hub

log syslog all;
debug protocols all;

router id 10.0.1.2;

# Kernel protocol - sync routes between BIRD and Linux kernel
protocol kernel {
    ipv4 {
        import none;
        export all;  # Export all BGP learned routes to kernel
    };
}

# Device protocol - monitor interface states
protocol device {
    scan time 10;
}

# Direct protocol - learn directly connected routes
protocol direct {
    ipv4;
    interface "wg0", "ens5";
}

# Static route for spoke-1 VPC network
protocol static spoke1_networks {
    ipv4;
    route 172.17.0.0/16 reject;  # Advertise but don't use (we have more specific routes)
}

# BGP session with Hub
protocol bgp hub {
    local 10.0.1.2 as 65001;
    neighbor 10.0.1.1 as 65000;
    
    ipv4 {
        import filter {
            # Accept all routes from hub (includes hub network + other spokes)
            if net ~ 172.16.0.0/16 then accept;  # Hub network
            if net ~ 172.18.0.0/16 then accept;  # Spoke-2 via hub
            reject;
        };
        export filter {
            # Only advertise our local spoke-1 network
            if net ~ 172.17.0.0/16 then accept;
            reject;
        };
    };
    
    hold time 90;
    keepalive time 30;
}
