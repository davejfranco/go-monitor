# BIRD configuration for hub-router
# Hub VPC: 172.16.0.0/16
# WireGuard tunnels: 10.0.1.1/30 (spoke-1), 10.0.2.1/30 (spoke-2)

log syslog all;
debug protocols all;

router id 10.0.1.1;

# Kernel protocol - sync routes between BIRD and Linux kernel
protocol kernel {
    ipv4 {
        import none;
        export all;  # Export all BGP learned routes to kernel
    };
    merge paths on;  # Enable ECMP if multiple paths exist
}

# Device protocol - monitor interface states
protocol device {
    scan time 10;
}

# Direct protocol - learn directly connected routes
protocol direct {
    ipv4;
    interface "wg0", "ens5";
}

# Static route for hub VPC network
protocol static hub_networks {
    ipv4;
    route 172.16.0.0/16 reject;  # Advertise but don't use (we have more specific routes)
}

# BGP session with Spoke-1
protocol bgp spoke1 {
    local 10.0.1.1 as 65000;
    neighbor 10.0.1.2 as 65001;
    
    ipv4 {
        import filter {
            # Accept routes from spoke-1
            if net ~ 172.17.0.0/16 then accept;
            reject;
        };
        export filter {
            # Send hub network and routes from other spokes
            if net ~ 172.16.0.0/16 then accept;
            if net ~ 172.18.0.0/16 then accept;  # Routes from spoke-2
            reject;
        };
    };
    
    hold time 90;
    keepalive time 30;
}

# BGP session with Spoke-2
protocol bgp spoke2 {
    local 10.0.2.1 as 65000;
    neighbor 10.0.2.2 as 65002;
    
    ipv4 {
        import filter {
            # Accept routes from spoke-2
            if net ~ 172.18.0.0/16 then accept;
            reject;
        };
        export filter {
            # Send hub network and routes from other spokes
            if net ~ 172.16.0.0/16 then accept;
            if net ~ 172.17.0.0/16 then accept;  # Routes from spoke-1
            reject;
        };
    };
    
    hold time 90;
    keepalive time 30;
}
